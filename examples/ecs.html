<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        html,body,canvas {
            border: 0px solid black;
            padding: 0;
            margin:0;
        }
    </style>
</head>
<body>
<button id="enter-fullscreen">fullscreen</button>
<canvas id="canvas" width="400" height="250"></canvas>

<script src="../node_modules/atlaspack/index.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/r105/build/three.js"></script>
<script type="module">
    import {World, System} from "../node_modules/ecsy/build/ecsy.module.js"
    import {ChunkManager} from '../src/ChunkManager'
    import {CulledMesher} from '../src/CulledMesher'
    import {TextureManager} from '../src/TextureManager'
    import {KeyboardNav, KeyboardState, Stage, DesktopControls, Highlight, FullscreenControls} from './InputComponents'
    import {ChunkManagerComponent, StandardThreeSceneSystem} from './ThreeComponents'

    const flat = (i,j,k) => {
        //an gap in the floor made of air
        // if(j <1 && k < -5 && k > -10 ) return 0
        //the floor is brick, from depth 0 to -10
        if(j < 1 && j > -10) return 1

        //move back 10
        k+=30
        //a dome
        if((i*i + j*j + k*k) < 80) {
            return 2
        }
        //nothing else in the world
        return 0
    }
    function generateChunkInfoFromFunction(l, h, f) {
        let d = [ h[0]-l[0], h[1]-l[1], h[2]-l[2] ]
        let v = new Int32Array(d[0]*d[1]*d[2])
        let n = 0;
        for(let k=l[2]; k<h[2]; ++k)
            for(let j=l[1]; j<h[1]; ++j)
                for(let i=l[0]; i<h[0]; ++i, ++n) {
                    v[n] = f(i,j,k);
                }
        return {
            low:l,
            high:h,
            voxels:v,
            dims:d,
        };
    }

    const chunkManager = new ChunkManager({
        chunkDistance:3,
        blockSize:1,
        mesher: new CulledMesher(),
        chunkSize:16,
        generateVoxelChunk: (low, high, pos) => {
            const id = [pos.x,pos.y,pos.z].join('|')
            return generateChunkInfoFromFunction(low, high, flat)
        },
        container: new THREE.Group(),
        textureManager: new TextureManager({aoEnabled:true}),
    });


    const world = new World();
    world.registerSingletonComponent(StandardThreeSceneSystem)
    world.components.standardThreeSceneSystem.world = world

    world.registerSingletonComponent(KeyboardState)
    world.registerSingletonComponent(Stage)
    world.registerSingletonComponent(ChunkManagerComponent)
    world.components.chunkManagerComponent.chunkManager = chunkManager

    world.registerSystem(KeyboardNav)
    world.registerSystem(DesktopControls)
    world.registerSystem(FullscreenControls)

    //attach the highlight
    const highlight  = world.createEntity()
    highlight.addComponent(Highlight)
    world.components.stage.position.add(highlight.getComponent(Highlight).mesh)

    chunkManager.textureManager.loadTextures([
        {
            src:'./textures/kenneynl/tiles/grass_top.png'
        },
        {
            src:'./textures/kenneynl/tiles/dirt.png'
        },
        {
            src:'./textures/kenneynl/tiles/ice.png',
        },
        {
            src:'./textures/kenneynl/tiles/lava.png',
        },
        {
            src:'./textures/kenneynl/tiles/stone.png',
        },
        {
            src:'./textures/kenneynl/tiles/sand.png',
        },
        {
            src:'./textures/tnt.png',
        },
        {
            src:'./textures/heart.png',
        },
    ]).then(()=>{
        chunkManager.rebuildAllMeshes()
        chunkManager.requestMissingChunks(new THREE.Vector3(0,0,0))
        world.components.standardThreeSceneSystem.scene.add(world.components.stage.rotation)
        world.components.stage.position.add(chunkManager.container)
    })

    document.querySelector("#enter-fullscreen").addEventListener('click',()=>{
        console.log("clicked to enter FS")
        // world.getSystem(DesktopControls).disable()
        const canvas = world.components.standardThreeSceneSystem.renderer.domElement
        if(canvas.requestFullScreen !== null) {
            canvas.requestFullscreen()
        } else {
            console.log("there is no fullscreen. we should fake it")
        }
    })

</script>

</body>
</html>

